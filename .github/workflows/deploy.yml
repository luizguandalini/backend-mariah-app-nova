name: Deploy to EC2

on:
  push:
    branches: [main]
  workflow_dispatch: # Permite trigger manual

env:
  NODE_VERSION: '20'

jobs:
  # ================================
  # Job 1: Build e VerificaÃ§Ã£o
  # ================================
  build:
    name: Build & Verify
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Instalar dependÃªncias
        run: npm install --legacy-peer-deps

      - name: ğŸ”¨ Build
        run: npm run build

      - name: âœ… Build concluÃ­do
        run: echo "Build concluÃ­do com sucesso!"

  # ================================
  # Job 2: Deploy para EC2
  # ================================
  deploy:
    name: Deploy to EC2
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸš€ Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "ğŸ“¦ Iniciando deploy..."
            
            # Navega para o diretÃ³rio do projeto
            cd /home/ec2-user/backend-novamaria
            
            # Pull das Ãºltimas alteraÃ§Ãµes
            echo "â¬‡ï¸ Baixando alteraÃ§Ãµes..."
            git pull origin main
            
            # Guarda a imagem atual como backup
            echo "ğŸ’¾ Criando backup da imagem atual..."
            docker tag mariah-backend:latest mariah-backend:backup 2>/dev/null || true
            
            # Rebuild e restart dos containers
            echo "ğŸ”¨ Reconstruindo containers..."
            docker compose -f docker-compose.prod.yml build --no-cache
            
            # Para containers antigos
            echo "â¹ï¸ Parando containers antigos..."
            docker compose -f docker-compose.prod.yml down
            
            # Sobe novos containers
            echo "â–¶ï¸ Iniciando novos containers..."
            docker compose -f docker-compose.prod.yml up -d
            
            # Aguarda e verifica health
            echo "â³ Aguardando inicializaÃ§Ã£o (30s)..."
            sleep 30
            
            # Testa health check
            echo "ğŸ¥ Verificando health check..."
            if curl -f http://localhost:3000/health; then
              echo ""
              echo "âœ… Deploy concluÃ­do com sucesso!"
            else
              echo "âŒ Health check falhou! Restaurando backup..."
              docker compose -f docker-compose.prod.yml down
              docker tag mariah-backend:backup mariah-backend:latest
              docker compose -f docker-compose.prod.yml up -d
              echo "ğŸ”„ VersÃ£o anterior restaurada."
              exit 1
            fi
            
            # Limpeza de imagens antigas
            echo "ğŸ§¹ Limpando imagens nÃ£o utilizadas..."
            docker image prune -f
            
            echo "ğŸ‰ Deploy finalizado!"

      - name: ğŸ“Š Status do Deploy
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deploy realizado com sucesso!"
          else
            echo "âŒ Deploy falhou. Verifique os logs acima."
          fi
