# Force Rebuild - Triggering Chromium Install
name: Deploy to EC2

on:
  push:
    branches: [main]
  workflow_dispatch: # Permite trigger manual

env:
  NODE_VERSION: '20'

jobs:
  # ================================
  # Job 1: Build e VerificaÃ§Ã£o
  # ================================
  build:
    name: Build & Verify
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¦ Instalar dependÃªncias
        run: npm install --legacy-peer-deps

      - name: ğŸ”¨ Build
        run: npm run build

      - name: âœ… Build concluÃ­do
        run: echo "Build concluÃ­do com sucesso!"

  # ================================
  # Job 2: Deploy para EC2
  # ================================
  deploy:
    name: Deploy to EC2
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸš€ Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        timeout-minutes: 20  # Aumentado para dar tempo ao build no EC2 Free Tier
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          command_timeout: 15m  # Timeout do comando SSH (15 minutos)
          script: |
            echo "ğŸ“¦ Iniciando deploy..."
            
            # Navega para o diretÃ³rio do projeto
            cd /home/ec2-user/backend-novamaria
            
            # ================================
            # VERIFICAÃ‡ÃƒO INTELIGENTE DE ESPAÃ‡O EM DISCO
            # ================================
            echo "ğŸ’¾ Verificando espaÃ§o em disco..."
            DISK_REQUIRED=5  # MÃ­nimo de 5GB necessÃ¡rios
            
            # FunÃ§Ã£o para verificar espaÃ§o disponÃ­vel
            check_disk_space() {
              df -BG / | awk 'NR==2 {print $4}' | sed 's/G//'
            }
            
            # VerificaÃ§Ã£o inicial
            DISK_AVAILABLE=$(check_disk_space)
            echo "ğŸ“Š EspaÃ§o disponÃ­vel: ${DISK_AVAILABLE}GB"
            echo "ğŸ“Š EspaÃ§o necessÃ¡rio: ${DISK_REQUIRED}GB"
            
            # Se nÃ£o houver espaÃ§o suficiente, tenta limpeza automÃ¡tica
            if [ "$DISK_AVAILABLE" -lt "$DISK_REQUIRED" ]; then
              echo "âš ï¸ EspaÃ§o insuficiente detectado. Iniciando limpeza automÃ¡tica..."
              
              # ===== TENTATIVA 1: Limpeza Docker BÃ¡sica =====
              echo "ğŸ§¹ [Tentativa 1/3] Limpeza Docker bÃ¡sica..."
              docker container prune -f
              docker image prune -f
              docker volume prune -f
              
              DISK_AVAILABLE=$(check_disk_space)
              echo "ğŸ“Š EspaÃ§o apÃ³s limpeza bÃ¡sica: ${DISK_AVAILABLE}GB"
              
              if [ "$DISK_AVAILABLE" -ge "$DISK_REQUIRED" ]; then
                echo "âœ… EspaÃ§o liberado com sucesso! Continuando deploy..."
              else
                # ===== TENTATIVA 2: Limpeza Docker Agressiva =====
                echo "ğŸ§¹ [Tentativa 2/3] Limpeza Docker agressiva (removendo imagens nÃ£o utilizadas)..."
                docker system prune -a -f
                
                DISK_AVAILABLE=$(check_disk_space)
                echo "ğŸ“Š EspaÃ§o apÃ³s limpeza agressiva: ${DISK_AVAILABLE}GB"
                
                if [ "$DISK_AVAILABLE" -ge "$DISK_REQUIRED" ]; then
                  echo "âœ… EspaÃ§o liberado com sucesso! Continuando deploy..."
                else
                  # ===== TENTATIVA 3: Limpeza de Logs e Cache do Sistema =====
                  echo "ğŸ§¹ [Tentativa 3/3] Limpeza de logs e cache do sistema..."
                  
                  # Limpa logs antigos do Docker
                  echo "Limpando logs do Docker..."
                  sudo find /var/lib/docker/containers/ -type f -name "*.log" -delete 2>/dev/null || true
                  
                  # Limpa logs do sistema (mantÃ©m Ãºltimos 7 dias)
                  echo "Limpando logs do sistema..."
                  sudo journalctl --vacuum-time=7d 2>/dev/null || true
                  
                  # Limpa cache do npm (se existir)
                  echo "Limpando cache do npm..."
                  npm cache clean --force 2>/dev/null || true
                  
                  # Limpa arquivos temporÃ¡rios
                  echo "Limpando arquivos temporÃ¡rios..."
                  sudo rm -rf /tmp/* 2>/dev/null || true
                  
                  DISK_AVAILABLE=$(check_disk_space)
                  echo "ğŸ“Š EspaÃ§o apÃ³s limpeza completa: ${DISK_AVAILABLE}GB"
                  
                  if [ "$DISK_AVAILABLE" -ge "$DISK_REQUIRED" ]; then
                    echo "âœ… EspaÃ§o liberado com sucesso! Continuando deploy..."
                  else
                    # ===== FALHA: NÃ£o foi possÃ­vel liberar espaÃ§o suficiente =====
                    echo "âŒ ERRO: NÃ£o foi possÃ­vel liberar espaÃ§o suficiente!"
                    echo "âŒ DisponÃ­vel apÃ³s todas as tentativas: ${DISK_AVAILABLE}GB"
                    echo "âŒ NecessÃ¡rio: ${DISK_REQUIRED}GB"
                    echo "âŒ Deploy abortado para manter versÃ£o atual rodando."
                    echo ""
                    echo "ğŸ“‹ AÃ§Ãµes recomendadas:"
                    echo "  1. Conecte-se ao servidor via SSH"
                    echo "  2. Execute: df -h (para ver uso de disco)"
                    echo "  3. Execute: du -sh /var/lib/docker (para ver uso do Docker)"
                    echo "  4. Considere aumentar o tamanho do disco da instÃ¢ncia EC2"
                    exit 1
                  fi
                fi
              fi
            else
              echo "âœ… EspaÃ§o em disco suficiente. Continuando deploy..."
            fi
            
            # Pull das Ãºltimas alteraÃ§Ãµes
            echo "â¬‡ï¸ Baixando alteraÃ§Ãµes..."
            git pull origin main
            
            # Guarda a imagem atual como backup
            echo "ğŸ’¾ Criando backup da imagem atual..."
            docker tag mariah-backend:latest mariah-backend:backup 2>/dev/null || true
            
            # Rebuild e restart dos containers
            echo "ğŸ”¨ Reconstruindo containers..."
            docker-compose -f docker-compose.prod.yml build --no-cache
            
            # Para containers antigos
            echo "â¹ï¸ Parando containers antigos..."
            docker-compose -f docker-compose.prod.yml down
            
            # Sobe novos containers
            echo "â–¶ï¸ Iniciando novos containers..."
            docker-compose -f docker-compose.prod.yml up -d
            
            # Aguarda e verifica health
            echo "â³ Aguardando inicializaÃ§Ã£o (30s)..."
            sleep 30
            
            # Testa health check
            echo "ğŸ¥ Verificando health check..."
            if curl -f http://localhost:80/health; then
              echo ""
              echo "âœ… Deploy concluÃ­do com sucesso!"
            else
              echo "âŒ Health check falhou! Restaurando backup..."
              docker-compose -f docker-compose.prod.yml down
              docker tag mariah-backend:backup mariah-backend:latest
              docker-compose -f docker-compose.prod.yml up -d
              echo "ğŸ”„ VersÃ£o anterior restaurada."
              exit 1
            fi
            
            # Limpeza de imagens antigas
            echo "ğŸ§¹ Limpando imagens nÃ£o utilizadas..."
            docker image prune -f
            
            echo "ğŸ‰ Deploy finalizado!"

      - name: ğŸ“Š Status do Deploy
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deploy realizado com sucesso!"
          else
            echo "âŒ Deploy falhou. Verifique os logs acima."
          fi
